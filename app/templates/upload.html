{% extends "base.html" %}

{% block title %}Upload Documents{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white shadow-lg rounded-lg p-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">Upload Documents</h1>
        
        <!-- Upload Zone -->
        <div id="upload-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center hover:border-gray-400 transition-colors">
            <div class="space-y-4">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <div class="text-gray-600">
                    <p class="text-lg font-medium">Drag and drop files here</p>
                    <p class="text-sm">or click to browse</p>
                </div>
                <input type="file" id="file-input" multiple accept=".pdf,.doc,.docx,.txt,.eml" class="hidden">
                <button id="browse-btn" class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition-colors">
                    Browse Files
                </button>
            </div>
        </div>

        <!-- File List -->
        <div id="file-list" class="mt-6 space-y-3 hidden">
            <h3 class="text-lg font-medium text-gray-900">Selected Files</h3>
            <div id="file-items" class="space-y-2"></div>
        </div>

        <!-- Upload Progress -->
        <div id="upload-progress" class="mt-6 hidden">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Upload Progress</h3>
            <div id="progress-bars" class="space-y-3"></div>
        </div>

        <!-- Upload Button -->
        <div id="upload-actions" class="mt-6 hidden">
            <button id="start-upload" class="bg-green-600 text-white px-8 py-3 rounded-md hover:bg-green-700 transition-colors">
                Start Upload
            </button>
        </div>

        <!-- Results Summary -->
        <div id="upload-results" class="mt-8 hidden">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Upload Results</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="text-2xl font-bold text-green-600" id="ingested-count">0</div>
                    <div class="text-sm text-green-600">Documents Ingested</div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div class="text-2xl font-bold text-yellow-600" id="dedup-count">0</div>
                    <div class="text-sm text-yellow-600">Duplicates Found</div>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="text-2xl font-bold text-blue-600" id="ocr-count">0</div>
                    <div class="text-sm text-blue-600">OCR Tasks</div>
                </div>
            </div>
        </div>

        <!-- Error Buckets -->
        <div id="error-buckets" class="mt-6 hidden">
            <h3 class="text-lg font-medium text-red-600 mb-4">Upload Errors</h3>
            <div id="error-list" class="space-y-2"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let selectedFiles = [];
    let uploadInProgress = false;

    // File selection
    document.getElementById('browse-btn').addEventListener('click', () => {
        document.getElementById('file-input').click();
    });

    document.getElementById('file-input').addEventListener('change', (e) => {
        selectedFiles = Array.from(e.target.files);
        displayFileList();
        showUploadActions();
    });

    // Drag and drop
    const uploadZone = document.getElementById('upload-zone');
    
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('border-blue-400', 'bg-blue-50');
    });

    uploadZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('border-blue-400', 'bg-blue-50');
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('border-blue-400', 'bg-blue-50');
        
        const files = Array.from(e.dataTransfer.files);
        selectedFiles = files.filter(file => {
            const validTypes = ['.pdf', '.doc', '.docx', '.txt', '.eml'];
            return validTypes.some(type => file.name.toLowerCase().endsWith(type));
        });
        
        displayFileList();
        showUploadActions();
    });

    function displayFileList() {
        const fileList = document.getElementById('file-list');
        const fileItems = document.getElementById('file-items');
        
        fileItems.innerHTML = '';
        selectedFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
            fileItem.innerHTML = `
                <div class="flex items-center space-x-3">
                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <div>
                        <div class="text-sm font-medium text-gray-900">${file.name}</div>
                        <div class="text-sm text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                    </div>
                </div>
                <button onclick="removeFile(${index})" class="text-red-600 hover:text-red-800">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            `;
            fileItems.appendChild(fileItem);
        });
        
        fileList.classList.remove('hidden');
    }

    function removeFile(index) {
        selectedFiles.splice(index, 1);
        if (selectedFiles.length === 0) {
            document.getElementById('file-list').classList.add('hidden');
            document.getElementById('upload-actions').classList.add('hidden');
        } else {
            displayFileList();
        }
    }

    function showUploadActions() {
        document.getElementById('upload-actions').classList.remove('hidden');
    }

    // Upload functionality
    document.getElementById('start-upload').addEventListener('click', startUpload);

    async function startUpload() {
        if (uploadInProgress) return;
        
        uploadInProgress = true;
        document.getElementById('start-upload').disabled = true;
        document.getElementById('start-upload').textContent = 'Uploading...';
        
        showUploadProgress();
        
        try {
            // Simulate upload process for demo
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                await simulateFileUpload(file, i);
            }
            
            // Show results
            showUploadResults();
            
        } catch (error) {
            console.error('Upload failed:', error);
            showError('Upload failed: ' + error.message);
        } finally {
            uploadInProgress = false;
            document.getElementById('start-upload').disabled = false;
            document.getElementById('start-upload').textContent = 'Start Upload';
        }
    }

    function showUploadProgress() {
        const progressSection = document.getElementById('upload-progress');
        const progressBars = document.getElementById('progress-bars');
        
        progressBars.innerHTML = '';
        selectedFiles.forEach((file, index) => {
            const progressBar = document.createElement('div');
            progressBar.className = 'space-y-2';
            progressBar.innerHTML = `
                <div class="flex justify-between text-sm">
                    <span class="text-gray-700">${file.name}</span>
                    <span class="text-gray-500" id="progress-text-${index}">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" id="progress-bar-${index}" style="width: 0%"></div>
                </div>
            `;
            progressBars.appendChild(progressBar);
        });
        
        progressSection.classList.remove('hidden');
    }

    async function simulateFileUpload(file, index) {
        return new Promise((resolve) => {
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    resolve();
                }
                
                document.getElementById(`progress-bar-${index}`).style.width = progress + '%';
                document.getElementById(`progress-text-${index}`).textContent = Math.round(progress) + '%';
            }, 200);
        });
    }

    function showUploadResults() {
        // Simulate results for demo
        document.getElementById('ingested-count').textContent = selectedFiles.length;
        document.getElementById('dedup-count').textContent = Math.floor(Math.random() * 3);
        document.getElementById('ocr-count').textContent = Math.floor(selectedFiles.length * 0.7);
        
        document.getElementById('upload-results').classList.remove('hidden');
    }

    function showError(message) {
        const errorBuckets = document.getElementById('error-buckets');
        const errorList = document.getElementById('error-list');
        
        const errorItem = document.createElement('div');
        errorItem.className = 'p-3 bg-red-50 border border-red-200 rounded-lg text-red-700';
        errorItem.textContent = message;
        
        errorList.appendChild(errorItem);
        errorBuckets.classList.remove('hidden');
    }
</script>
{% endblock %}
